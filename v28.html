<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROOT_ACCESS v28.4 (DASHBOARD)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* üé® v28 ÁªèÂÖ∏ÈªëÈáëÈ£éÊ†º */
        :root { --ai-accent: #B89648; --ai-bg-card: rgba(15, 15, 15, 0.98); }
        body { 
            height: 100dvh; width: 100vw; overflow-y: auto; 
            background: #050505 radial-gradient(circle at 50% 0%, #1a1b2e 0%, transparent 70%);
            display: flex; flex-direction: column; align-items: center; 
            font-family: 'Inter', sans-serif; margin: 0;
        }
        .manage-container { 
            width: 95%; max-width: 450px; margin-top: 100px; background: var(--ai-bg-card); 
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            margin-bottom: 50px;
        }
        .title { color: var(--ai-accent); font-weight: 700; font-size: 13px; margin-bottom: 20px; border-bottom: 1px dashed rgba(184,150,72,0.3); padding-bottom: 10px; letter-spacing: 1px; text-align:center; }
        
        /* üìä ‰ª™Ë°®ÁõòÂå∫Âüü */
        .dashboard-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 5px;
        }
        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 14px; font-weight: 700; color: #fff; font-family: monospace; }
        
        /* ËøõÂ∫¶Êù°Ê†∑Âºè */
        .progress-track {
            width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: var(--ai-accent); width: 0%; transition: width 1s ease;
        }
        
        /* B2 ÊåâÈíÆ */
        .btn-b2 {
            background: rgba(184, 150, 72, 0.1); border: 1px solid var(--ai-accent);
            color: var(--ai-accent); border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; padding: 8px; text-decoration: none; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            transition: all 0.2s; height: 100%; box-sizing: border-box;
        }
        .btn-b2:hover { background: var(--ai-accent); color: #000; }

        /* ÁôªÂΩï‰∏éÂàóË°®Ê†∑Âºè */
        .auth-box { display: flex; flex-direction: column; gap: 10px; }
        .pw-input { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 6px; box-sizing: border-box; text-align: center; }
        .pw-input:focus { border-color: var(--ai-accent); outline: none; }
        .btn-verify { width: 100%; padding: 13px; background: var(--ai-accent); color: #000; border: none; border-radius: 50px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        .search-box { width: 100%; margin-bottom: 15px; display: none; }
        .search-input { width: 100%; padding: 10px; background: #000; border: 1px solid rgba(184,150,72,0.4); color: #fff; border-radius: 6px; box-sizing: border-box; }
        
        .data-item { padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .data-info { font-size: 14px; font-weight: 600; color: #ddd; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sort-tag { color: var(--ai-accent); font-size: 10px; margin-right: 8px; opacity: 0.8; font-family: monospace; }
        
        .btn-group { display: flex; gap: 6px; }
        button { border: 1px solid transparent; background: transparent; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-view { border-color: #3b82f6; color: #3b82f6; }
        .btn-edit { border-color: #4ade80; color: #4ade80; }
        .btn-del { border-color: #ff4444; color: #ff4444; }

        #imgOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; }
        #imgOverlay img { max-width: 90%; max-height: 80%; border: 2px solid var(--ai-accent); border-radius: 8px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { width: 90%; max-width: 400px; background: #111; border: 1px solid var(--ai-accent); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .edit-label { color: #666; font-size: 11px; margin-bottom: -5px; margin-top: 5px; }
        .edit-input, .edit-area { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        .edit-area { height: 100px; resize: none; border-left: 2px solid var(--ai-accent); }
    </style>
</head>
<body>

    <div id="imgOverlay" onclick="closeImg()"><img id="fullImg" decoding="async"></div>

    <div class="manage-container">
        <div class="title">ROOT_ACCESS v28.4 (DASHBOARD)</div>
        
        <div id="authBox" class="auth-box">
            <input type="email" id="adminEmail" class="pw-input" placeholder="Admin Email" autocomplete="username">
            <input type="password" id="adminPass" class="pw-input" placeholder="Password" autocomplete="current-password">
            <button class="btn-verify" onclick="verify()">Login to Database</button>
            <div id="loginStatus" style="color:#ff4444; font-size:12px; text-align:center;"></div>
        </div>

        <div id="dashboard" class="dashboard-grid" style="display:none;">
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between;">
                    <span class="stat-label">SUPABASE STORAGE</span>
                    <span id="sbPercent" class="stat-label" style="color:var(--ai-accent);">0%</span>
                </div>
                <div id="sbUsage" class="stat-value">Checking...</div>
                <div class="progress-track">
                    <div id="sbBar" class="progress-fill"></div>
                </div>
            </div>
            
            <div class="stat-card" style="justify-content:center; padding:0; background:transparent; border:none;">
                <a href="https://secure.backblaze.com/user_signin.htm" target="_blank" class="btn-b2">
                    <span>üî• Backblaze B2</span>
                    <span style="font-size:9px; opacity:0.7;">View Usage ‚Üó</span>
                </a>
            </div>
        </div>

        <div id="searchContainer" class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Search..." oninput="doSearch()">
        </div>

        <div id="controlPanel" style="display:none;">
            <div id="listContent" style="text-align:center; color:#666;">Waiting...</div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <div style="color:var(--ai-accent); font-weight:700; text-align:center;">EDIT CONTENT</div>
            
            <label class="edit-label">Sort Order (Number)</label>
            <input type="number" id="editSort" class="edit-input" placeholder="0">
            
            <label class="edit-label">Title</label>
            <input type="text" id="editTitle" class="edit-input">
            
            <label class="edit-label">Category</label>
            <input type="text" id="editCategory" class="edit-input">
            
            <label class="edit-label">Image URL</label>
            <input type="text" id="editImgUrl" class="edit-input">
            
            <label class="edit-label">Prompt</label>
            <textarea id="editPrompt" class="edit-area"></textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="closeModal()" style="flex:1; background:#333; color:#fff; padding:10px;">CANCEL</button>
                <button onclick="saveChanges()" style="flex:2; background:var(--ai-accent); color:#000; padding:10px; font-weight:700;">SAVE</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mcnilpwwzjtacotgzfcz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_LXmgVKowe5CIOr9v_PtODQ_dtC1fqkS';
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let currentEditId = null;

        async function verify() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPass').value.trim();
            const statusDiv = document.getElementById('loginStatus');

            statusDiv.innerText = "Verifying...";
            const { data, error } = await client.auth.signInWithPassword({ email, password });

            if (error) {
                statusDiv.innerText = "‚ùå ÁôªÂΩïÂ§±Ë¥•: " + error.message;
                alert("ACCESS DENIED: Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØ");
            } else {
                statusDiv.innerText = "";
                document.getElementById('authBox').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid'; // ÊòæÁ§∫‰ª™Ë°®Áõò
                document.getElementById('searchContainer').style.display = 'block';
                document.getElementById('controlPanel').style.display = 'block';
                loadData(); 
                checkStorageUsage(); // üî• Ëß¶ÂèëÊü•Ë¥¶
            }
        }

        // üî• Ê†∏ÂøÉÔºöÊü• Supabase Áî®Èáè
        async function checkStorageUsage() {
            // Ë∞ÉÁî®ÂàöÊâçÂàõÂª∫ÁöÑ SQL ÂáΩÊï∞
            const { data, error } = await client.rpc('get_images_size');
            
            if (!error && data !== null) {
                const totalBytes = data;
                const limitBytes = 500 * 1024 * 1024; // 500MB
                
                // ËΩ¨Êàê MB
                const usedMB = (totalBytes / (1024 * 1024)).toFixed(2);
                const percent = Math.min((totalBytes / limitBytes) * 100, 100).toFixed(1);
                
                // Êõ¥Êñ∞ UI
                document.getElementById('sbUsage').innerText = `${usedMB} MB / 500 MB`;
                document.getElementById('sbPercent').innerText = `${percent}%`;
                document.getElementById('sbBar').style.width = `${percent}%`;
                
                // È¢ÑË≠¶È¢úËâ≤
                if(percent > 80) document.getElementById('sbBar').style.backgroundColor = '#ff4444';
            } else {
                document.getElementById('sbUsage').innerText = "Error";
            }
        }

        async function loadData() {
            document.getElementById('listContent').innerText = "Syncing with Database...";
            const { data, error } = await client.from('prompts')
                .select('*')
                .order('sort_order', { ascending: false })
                .order('id', { ascending: false });

            if(error) {
                document.getElementById('listContent').innerText = "‚ùå Error: " + error.message;
            } else {
                allData = data; renderList(allData);
            }
        }

        function renderList(items) {
            document.getElementById('listContent').innerHTML = items.map(item => `
                <div class="data-item">
                    <span class="data-info"><span class="sort-tag">[W:${item.sort_order||0}]</span>${item.title}</span>
                    <div class="btn-group">
                        <button class="btn-view" onclick="showImg('${item.imageUrl}')">Êü•Áúã</button>
                        <button class="btn-edit" onclick="openEdit(${item.id})">‰øÆÊîπ</button>
                        <button class="btn-del" onclick="doDelete(${item.id})">ÈîÄÊØÅ</button>
                    </div>
                </div>
            `).join('');
        }

        function showImg(url) {
            if(url && url!=='null') {
                document.getElementById('fullImg').src = url; 
                document.getElementById('imgOverlay').style.display = 'flex';
            } else alert("Êó†ÂõæÁâáÈìæÊé•");
        }
        function closeImg() { document.getElementById('imgOverlay').style.display = 'none'; }

        function openEdit(id) {
            currentEditId = id;
            const item = allData.find(i => i.id === id);
            
            const sortVal = item.sort_order;
            document.getElementById('editSort').value = (sortVal === null || sortVal === undefined) ? 0 : sortVal;

            document.getElementById('editTitle').value = item.title || "";
            document.getElementById('editCategory').value = item.category || "";
            document.getElementById('editImgUrl').value = item.imageUrl || "";
            document.getElementById('editPrompt').value = item.prompt || "";
            
            document.getElementById('editModal').style.display = 'flex';
        }

        async function saveChanges() {
            const sortInput = document.getElementById('editSort').value.trim();
            const sortOrderValue = sortInput === "" ? 0 : parseInt(sortInput);

            const updates = {
                sort_order: sortOrderValue,
                title: document.getElementById('editTitle').value.trim(),
                category: document.getElementById('editCategory').value.trim(),
                imageUrl: document.getElementById('editImgUrl').value.trim(),
                prompt: document.getElementById('editPrompt').value.trim()
            };

            const { error } = await client.from('prompts').update(updates).eq('id', currentEditId);
            if(!error) { closeModal(); loadData(); } else alert("Save Failed: " + error.message);
        }

        function closeModal() { document.getElementById('editModal').style.display = 'none'; }
        
        async function doDelete(id) {
            if (!confirm("‚ö†Ô∏è Á°ÆÂÆöË¶Å‰ªéÊï∞ÊçÆÂ∫ì‰∏≠ÈîÄÊØÅÊ≠§ËÆ∞ÂΩïÂêóÔºü\n(B2Êñá‰ª∂ÈúÄÂçïÁã¨Ê∏ÖÁêÜ)")) return;
            const { error } = await client.from('prompts').delete().eq('id', id);
            if(!error) loadData(); checkStorageUsage(); // Âà†Èô§ÂêéÂà∑Êñ∞Áî®Èáè
        }

        function doSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderList(allData.filter(i => (i.title+i.category).toLowerCase().includes(q)));
        }
    </script>
</body>
</html>
