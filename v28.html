<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROOT_ACCESS v28.6 (AUTO-COMPRESS)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ğŸ¨ v28 ç»å…¸é»‘é‡‘é£æ ¼ */
        :root { --ai-accent: #B89648; --ai-bg-card: rgba(15, 15, 15, 0.98); }
        body { 
            height: 100dvh; width: 100vw; overflow-y: auto; 
            background: #050505 radial-gradient(circle at 50% 0%, #1a1b2e 0%, transparent 70%);
            display: flex; flex-direction: column; align-items: center; 
            font-family: 'Inter', sans-serif; margin: 0;
        }
        .manage-container { 
            width: 95%; max-width: 450px; margin-top: 100px; background: var(--ai-bg-card); 
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            margin-bottom: 50px;
        }
        .title { color: var(--ai-accent); font-weight: 700; font-size: 13px; margin-bottom: 20px; border-bottom: 1px dashed rgba(184,150,72,0.3); padding-bottom: 10px; letter-spacing: 1px; text-align:center; }
        
        /* ğŸ“Š ä»ªè¡¨ç›˜åŒºåŸŸ */
        .dashboard-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 5px;
        }
        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 14px; font-weight: 700; color: #fff; font-family: monospace; }
        .progress-track { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--ai-accent); width: 0%; transition: width 1s ease; }
        
        .btn-b2 {
            background: rgba(184, 150, 72, 0.1); border: 1px solid var(--ai-accent);
            color: var(--ai-accent); border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; padding: 8px; text-decoration: none; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            transition: all 0.2s; height: 100%; box-sizing: border-box;
        }
        .btn-b2:hover { background: var(--ai-accent); color: #000; }

        /* ç™»å½•ä¸åˆ—è¡¨æ ·å¼ */
        .auth-box { display: flex; flex-direction: column; gap: 10px; }
        .pw-input { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 6px; box-sizing: border-box; text-align: center; }
        .pw-input:focus { border-color: var(--ai-accent); outline: none; }
        .btn-verify { width: 100%; padding: 13px; background: var(--ai-accent); color: #000; border: none; border-radius: 50px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        .search-box { width: 100%; margin-bottom: 15px; display: none; }
        .search-input { width: 100%; padding: 10px; background: #000; border: 1px solid rgba(184,150,72,0.4); color: #fff; border-radius: 6px; box-sizing: border-box; }
        
        .data-item { padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .data-info { font-size: 14px; font-weight: 600; color: #ddd; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sort-tag { color: var(--ai-accent); font-size: 10px; margin-right: 8px; opacity: 0.8; font-family: monospace; }
        
        .btn-group { display: flex; gap: 6px; }
        button { border: 1px solid transparent; background: transparent; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-view { border-color: #3b82f6; color: #3b82f6; }
        .btn-edit { border-color: #4ade80; color: #4ade80; }
        .btn-del { border-color: #ff4444; color: #ff4444; }

        #imgOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; }
        #imgOverlay img { max-width: 90%; max-height: 80%; border: 2px solid var(--ai-accent); border-radius: 8px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { width: 90%; max-width: 400px; background: #111; border: 1px solid var(--ai-accent); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .edit-label { color: #666; font-size: 11px; margin-bottom: -5px; margin-top: 5px; }
        .edit-input, .edit-area { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        .edit-area { height: 100px; resize: none; border-left: 2px solid var(--ai-accent); }

        /* ğŸ”¥ ä¸Šä¼ æŒ‰é’® & ç»¿è‰²æˆ˜æŠ¥æ ·å¼ */
        .file-upload-btn {
            background: #222; border: 1px dashed #555; color: #888; padding: 10px;
            text-align: center; border-radius: 6px; cursor: pointer; font-size: 12px;
            margin-bottom: 5px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .file-upload-btn:hover { border-color: #888; color: #ccc; }
        .file-upload-btn.selected { border-color: var(--ai-accent); color: var(--ai-accent); background: rgba(184,150,72,0.1); }
        
        /* ğŸŸ© ç»¿è‰²èŠ‚èƒ½æ•°æ®æ˜¾ç¤º */
        .compress-stat {
            font-size: 10px; color: #4ade80; text-align: center; margin-bottom: 10px;
            font-family: monospace; display: none; /* é»˜è®¤éšè— */
        }
    </style>
</head>
<body>

    <div id="imgOverlay" onclick="closeImg()"><img id="fullImg" decoding="async"></div>

    <div class="manage-container">
        <div class="title">ROOT_ACCESS v28.6 (AUTO-COMPRESS)</div>
        
        <div id="authBox" class="auth-box">
            <input type="email" id="adminEmail" class="pw-input" placeholder="Admin Email" autocomplete="username">
            <input type="password" id="adminPass" class="pw-input" placeholder="Password" autocomplete="current-password">
            <button class="btn-verify" onclick="verify()">Login to Database</button>
            <div id="loginStatus" style="color:#ff4444; font-size:12px; text-align:center;"></div>
        </div>

        <div id="dashboard" class="dashboard-grid" style="display:none;">
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between;">
                    <span class="stat-label">SUPABASE STORAGE</span>
                    <span id="sbPercent" class="stat-label" style="color:var(--ai-accent);">0%</span>
                </div>
                <div id="sbUsage" class="stat-value">Checking...</div>
                <div class="progress-track"><div id="sbBar" class="progress-fill"></div></div>
            </div>
            <div class="stat-card" style="justify-content:center; padding:0; background:transparent; border:none;">
                <a href="https://secure.backblaze.com/user_signin.htm" target="_blank" class="btn-b2">
                    <span>ğŸ”¥ Backblaze B2</span><span style="font-size:9px; opacity:0.7;">View Usage â†—</span>
                </a>
            </div>
        </div>

        <div id="searchContainer" class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” Search..." oninput="doSearch()">
        </div>

        <div id="controlPanel" style="display:none;">
            <div id="listContent" style="text-align:center; color:#666;">Waiting...</div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <div style="color:var(--ai-accent); font-weight:700; text-align:center;">EDIT CONTENT</div>
            
            <label class="edit-label">Sort Order (Number)</label>
            <input type="number" id="editSort" class="edit-input" placeholder="0">
            
            <label class="edit-label">Title</label>
            <input type="text" id="editTitle" class="edit-input">
            
            <label class="edit-label">Category</label>
            <input type="text" id="editCategory" class="edit-input">
            
            <label class="edit-label">Image URL / Replace</label>
            
            <input type="file" id="editFileIn" hidden accept="image/*" onchange="handleFileSelect(this)">
            <div id="editFileBtn" class="file-upload-btn" onclick="document.getElementById('editFileIn').click()">
                <span>ğŸ“‚</span> ç‚¹å‡»ä¸Šä¼ æ–°å›¾ç‰‡ (è¦†ç›–æ—§å›¾)
            </div>
            <div id="compressMsg" class="compress-stat"></div>
            
            <input type="text" id="editImgUrl" class="edit-input" placeholder="æˆ–æ‰‹åŠ¨ç²˜è´´é“¾æ¥...">
            
            <label class="edit-label">Prompt</label>
            <textarea id="editPrompt" class="edit-area"></textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="closeModal()" style="flex:1; background:#333; color:#fff; padding:10px;">CANCEL</button>
                <button id="saveBtn" onclick="saveChanges()" style="flex:2; background:var(--ai-accent); color:#000; padding:10px; font-weight:700;">SAVE</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mcnilpwwzjtacotgzfcz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_LXmgVKowe5CIOr9v_PtODQ_dtC1fqkS';
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let currentEditId = null;
        let selectedNewFile = null;

        async function verify() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPass').value.trim();
            const statusDiv = document.getElementById('loginStatus');

            statusDiv.innerText = "Verifying...";
            const { data, error } = await client.auth.signInWithPassword({ email, password });

            if (error) {
                statusDiv.innerText = "âŒ ç™»å½•å¤±è´¥: " + error.message;
                alert("ACCESS DENIED: è´¦å·æˆ–å¯†ç é”™è¯¯");
            } else {
                statusDiv.innerText = "";
                document.getElementById('authBox').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid'; 
                document.getElementById('searchContainer').style.display = 'block';
                document.getElementById('controlPanel').style.display = 'block';
                loadData(); 
                checkStorageUsage(); 
            }
        }

        async function checkStorageUsage() {
            const { data, error } = await client.rpc('get_images_size');
            if (!error && data !== null) {
                const totalBytes = data;
                const limitBytes = 500 * 1024 * 1024; 
                const usedMB = (totalBytes / (1024 * 1024)).toFixed(2);
                const percent = Math.min((totalBytes / limitBytes) * 100, 100).toFixed(1);
                document.getElementById('sbUsage').innerText = `${usedMB} MB / 500 MB`;
                document.getElementById('sbPercent').innerText = `${percent}%`;
                document.getElementById('sbBar').style.width = `${percent}%`;
                if(percent > 80) document.getElementById('sbBar').style.backgroundColor = '#ff4444';
            } else {
                document.getElementById('sbUsage').innerText = "Error";
            }
        }

        async function loadData() {
            document.getElementById('listContent').innerText = "Syncing with Database...";
            const { data, error } = await client.from('prompts').select('*').order('sort_order', { ascending: false }).order('id', { ascending: false });
            if(error) { document.getElementById('listContent').innerText = "âŒ Error: " + error.message; }
            else { allData = data; renderList(allData); }
        }

        function renderList(items) {
            document.getElementById('listContent').innerHTML = items.map(item => `
                <div class="data-item">
                    <span class="data-info"><span class="sort-tag">[W:${item.sort_order||0}]</span>${item.title}</span>
                    <div class="btn-group">
                        <button class="btn-view" onclick="showImg('${item.imageUrl}')">æŸ¥çœ‹</button>
                        <button class="btn-edit" onclick="openEdit(${item.id})">ä¿®æ”¹</button>
                        <button class="btn-del" onclick="doDelete(${item.id})">é”€æ¯</button>
                    </div>
                </div>
            `).join('');
        }

        function showImg(url) {
            if(url && url!=='null') {
                document.getElementById('fullImg').src = url; 
                document.getElementById('imgOverlay').style.display = 'flex';
            } else alert("æ— å›¾ç‰‡é“¾æ¥");
        }
        function closeImg() { document.getElementById('imgOverlay').style.display = 'none'; }

        // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šæ–‡ä»¶åæˆªæ–­ (å‰17 + ... + å5)
        function truncateName(name) {
            if (!name) return "";
            if (name.length <= 25) return name;
            return name.substring(0, 17) + "..." + name.substring(name.length - 5);
        }

        function formatSize(bytes) {
            if(bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function openEdit(id) {
            currentEditId = id;
            selectedNewFile = null;
            const item = allData.find(i => i.id === id);
            
            const sortVal = item.sort_order;
            document.getElementById('editSort').value = (sortVal === null || sortVal === undefined) ? 0 : sortVal;
            document.getElementById('editTitle').value = item.title || "";
            document.getElementById('editCategory').value = item.category || "";
            document.getElementById('editImgUrl').value = item.imageUrl || "";
            document.getElementById('editPrompt').value = item.prompt || "";
            
            // é‡ç½®æ–‡ä»¶é€‰æ‹© & çŠ¶æ€æ˜¾ç¤º
            document.getElementById('editFileIn').value = "";
            const btn = document.getElementById('editFileBtn');
            btn.innerHTML = "<span>ğŸ“‚</span> ç‚¹å‡»ä¸Šä¼ æ–°å›¾ç‰‡ (è¦†ç›–æ—§å›¾)";
            btn.classList.remove('selected');
            document.getElementById('compressMsg').style.display = 'none'; // éšè—ç»¿è‰²æ•°æ®

            document.getElementById('editModal').style.display = 'flex';
        }

        // ğŸ”¥ æ ¸å¿ƒï¼šå¤„ç†æ–‡ä»¶ + å‹ç¼© + æ˜¾ç¤ºç»¿è‰²æ•°æ®
        async function handleFileSelect(input) {
            if(input.files && input.files[0]) {
                const btn = document.getElementById('editFileBtn');
                const msgDiv = document.getElementById('compressMsg');
                const original = input.files[0];
                
                btn.innerText = "âš¡ æ­£åœ¨æè‡´å‹ç¼©ä¸­...";
                msgDiv.style.display = 'none';

                try {
                    // å¦‚æœæ˜¯ GIFï¼Œç›´æ¥è·³è¿‡å‹ç¼©
                    if(original.type === 'image/gif') {
                        selectedNewFile = original;
                        btn.innerText = "ğŸï¸ å·²å°±ç»ª: " + truncateName(original.name);
                        msgDiv.innerHTML = `GIF åŸå›¾ç›´ä¼ : ${formatSize(original.size)}`;
                        msgDiv.style.display = 'block';
                    } else {
                        // å¼€å§‹å‹ç¼© (å‚æ•° 0.82)
                        const compressed = await compressImage(original); 
                        
                        // é˜²åå‘å‹ç¼©é€»è¾‘ï¼šå¦‚æœå‹å®Œåè€Œå˜å¤§ï¼Œå°±ç”¨åŸå›¾
                        if(compressed.size >= original.size) {
                            selectedNewFile = original;
                            btn.innerText = "âœ… å·²å°±ç»ª: " + truncateName(original.name);
                            msgDiv.innerHTML = `åŸå›¾æ›´å°ï¼Œå·²ä¿ç•™åŸå›¾: ${formatSize(original.size)}`;
                        } else {
                            selectedNewFile = compressed;
                            // ä¿æŒåŸå§‹åç¼€åçš„è§†è§‰æ˜¾ç¤ºï¼Œè™½ç„¶å·²ç»æ˜¯ webp
                            btn.innerText = "âœ… å·²å°±ç»ª: " + truncateName(original.name);
                            
                            // è®¡ç®—èŠ‚çº¦æ¯”ä¾‹
                            const savedPercent = ((original.size - compressed.size) / original.size * 100).toFixed(0);
                            
                            // ğŸŸ© ç»¿è‰²æˆ˜æŠ¥æ˜¾ç¤º
                            msgDiv.innerHTML = `[å‹ç¼©æˆåŠŸ] ${formatSize(original.size)} -> ${formatSize(compressed.size)} (èŠ‚çº¦ ${savedPercent}%)`;
                        }
                        
                        btn.classList.add('selected');
                        msgDiv.style.display = 'block';
                    }
                } catch(e) {
                    alert("å›¾ç‰‡å¤„ç†å¤±è´¥: " + e.message);
                    selectedNewFile = null;
                }
            }
        }

        // ğŸ”¥ ç§»æ¤è‡ª admin çš„å‹ç¼©å¼•æ“ (0.82)
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 2000;
                        let width = img.width; let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (!blob) return reject(new Error('Canvas empty'));
                            // å¼ºåˆ¶è½¬ä¸º webp
                            const newName = file.name.replace(/\.[^/.]+$/, "") + ".webp";
                            resolve(new File([blob], newName, { type: 'image/webp' }));
                        }, 'image/webp', 0.82); // ğŸ¯ é»„é‡‘å‚æ•°
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function saveChanges() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "â³ Saving...";
            btn.disabled = true;

            try {
                const oldUrl = document.getElementById('editImgUrl').value.trim();
                let finalUrl = oldUrl;

                if(selectedNewFile) {
                    const safeName = `${Date.now()}_${selectedNewFile.name.replace(/\s/g, '')}`;
                    const { error: upErr } = await client.storage.from('images').upload(safeName, selectedNewFile);
                    if(upErr) throw upErr;
                    
                    const { data: { publicUrl } } = client.storage.from('images').getPublicUrl(safeName);
                    finalUrl = publicUrl;

                    if(oldUrl && oldUrl.includes('supabase.co') && oldUrl !== finalUrl) {
                        const pathParts = oldUrl.split('/images/');
                        if(pathParts.length > 1) {
                            const oldFileName = decodeURIComponent(pathParts[1]);
                            client.storage.from('images').remove([oldFileName]);
                        }
                    }
                } else {
                    finalUrl = document.getElementById('editImgUrl').value.trim();
                }

                const sortInput = document.getElementById('editSort').value.trim();
                const sortOrderValue = sortInput === "" ? 0 : parseInt(sortInput);

                const updates = {
                    sort_order: sortOrderValue,
                    title: document.getElementById('editTitle').value.trim(),
                    category: document.getElementById('editCategory').value.trim(),
                    imageUrl: finalUrl,
                    prompt: document.getElementById('editPrompt').value.trim()
                };

                const { error } = await client.from('prompts').update(updates).eq('id', currentEditId);
                if(error) throw error;

                closeModal(); loadData(); checkStorageUsage(); 
                alert("âœ… ä¿®æ”¹æˆåŠŸï¼");

            } catch (err) {
                alert("Save Failed: " + err.message);
            } finally {
                btn.innerText = "SAVE";
                btn.disabled = false;
            }
        }

        function closeModal() { document.getElementById('editModal').style.display = 'none'; }
        
        async function doDelete(id) {
            if (!confirm("âš ï¸ ç¡®å®šè¦ä»æ•°æ®åº“ä¸­é”€æ¯æ­¤è®°å½•å—ï¼Ÿ\n(B2æ–‡ä»¶éœ€å•ç‹¬æ¸…ç†)")) return;
            const { error } = await client.from('prompts').delete().eq('id', id);
            if(!error) { loadData(); checkStorageUsage(); }
            else alert("Delete Failed: " + error.message);
        }

        function doSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderList(allData.filter(i => (i.title+i.category).toLowerCase().includes(q)));
        }
    </script>
</body>
</html>
